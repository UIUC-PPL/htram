CHARMPATH=/project/projectdirs/m4167/finegrain/charm
CHARMBUILD=mpi-crayxc
CHARMC=$(CHARMPATH)/$(CHARMBUILD)-smp/bin/charmc $(OPTS)
NONSMP_CHARMC=$(CHARMPATH)/$(CHARMBUILD)/bin/charmc $(OPTS)

BINARY = histo_smp histo_nonSmp

CHARMCFLAGS = $(OPTS) -O3

all: $(BINARY)

histo_nonSmp.decl.h histo_nonSmp.def.h: histo_nonSmp.ci
	$(NONSMP_CHARMC) histo_nonSmp.ci

histo_nonSmp: histo_nonSmp.ci histo_nonSmp.C histo_nonSmp.def.h histo_nonSmp.decl.h
	$(NONSMP_CHARMC) histo_nonSmp.C libtramnonsmp.a -o histo_nonsmp -O3 -language charm++

histo_nonSmp.prj: histo_nonSmp.ci histo_nonSmp.C histo_nonSmp.def.h histo_nonSmp.decl.h
	$(NONSMP_CHARMC) histo_nonSmp.C libtramnonsmp.a -o histo_nonsmp.prj -O3 -language charm++ -tracemode projections


histo-non-smp-run:
	./charmrun +p32 ./histo_nonsmp -n 1000000 -T 10000 +setcpuaffinity

histo_smp: histo.o
	$(CHARMC) $(CHARMCFLAGS) libhtram.a -language charm++ -o $@ $+ -std=c++1z
histo_smp.prj: histo.o
	$(CHARMC) $(CHARMCFLAGS) libhtram.a -language charm++ -o $@ $+ -std=c++1z -tracemode projections

histo_smp_group: histo_group.o
	$(CHARMC) $(CHARMCFLAGS) libhtram_group.a -language charm++ -o $@ $+ -std=c++1z

histo_smp_sort: histo_sort.o
	$(CHARMC) $(CHARMCFLAGS) libhtram_sort.a -language charm++ -o $@ $+ -std=c++1z

.SECONDARY: $(patsubst %.C,%.decl.h,$(wildcard *.C))
.SECONDARY: $(patsubst %.C,%.def.h,$(wildcard *.C))

histo.def.h histo.decl.h: histo.ci
	$(CHARMC) histo.ci
	
histo_g.def.h histo_g.decl.h: histo_g.ci.stamp

histo_s.def.h histo_s.decl.h: histo_s.ci.stamp

histo.ci.stamp: histo.ci
	$(CHARMC) $(CHARMCFLAGS) $<
	touch $@

histo_g.ci.stamp: histo.ci
	$(CHARMC) $(CHARMCFLAGS) $< -DGROUPBY=1
	touch $@

histo.o: histo.C histo.decl.h histo.def.h
	$(CHARMC) $(CHARMCFLAGS) -c histo.C

histo_group.o: histo.C histo_g.decl.h histo_g.def.h
	$(CHARMC) $(CHARMCFLAGS) -c histo.C -o histo_group.o -DGROUPBY=1

histo_s.ci.stamp: histo.ci
	$(CHARMC) $(CHARMCFLAGS) $< -DSORTBY=1
	touch $@

histo_sort.o: histo.C histo_s.decl.h histo_s.def.h
	$(CHARMC) $(CHARMCFLAGS) -c histo.C -o histo_sort.o -DSORTBY=1



test: $(BINARY)
	$(call run, +p4 ./histo 14 8 )
smp-run:
	./histo -n 1000000 -T 10000 +setcpuaffinity ++ppn 32  +pemap 0-31 +commap 34
non-smp-run:
	./charmrun +p32 ./histo -n 1000000 -T 10000 +setcpuaffinity ++local


clean:
	rm -f *.o *.decl.h *.def.h $(BINARY) charmrun* *.stamp
	rm histo_smp*
	$(MAKE) clean
