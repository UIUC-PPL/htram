-include ../../../common.mk
CHARMC = ../../../bin/charmc
NONSMP_CHARMC = ../../.../bin/charmc
BINARY = histo

CHARMCFLAGS = $(OPTS) -O3

all: $(BINARY)

histo_nonSmp: histo_nonSmp.ci histo_nonSmp.C histo_nonSmp.def.hi histo_nonSmp.decl.h
	$(NONSMP_CHARMC) histo_nonSmp.ci
	$(NONSMP_CHARMC) histo_nonSmp.C libtramnonsmp.a -o histo_nonsmp.out -O3 -language charm++

histo-non-smp-run:
	./charmrun +p32 ./histo_nonsmp.out -n 1000000 -T 10000 +setcpuaffinity

histo: histo.o
	$(CHARMC) $(CHARMCFLAGS) libhtram.a -language charm++ -o $@ $+ -std=c++1z

.SECONDARY: $(patsubst %.C,%.decl.h,$(wildcard *.C))
.SECONDARY: $(patsubst %.C,%.def.h,$(wildcard *.C))

histo.def.h histo.decl.h: histo.ci.stamp

histo.ci.stamp: histo.ci
	$(CHARMC) $(CHARMCFLAGS) $<
	touch $@

histo.o: histo.C histo.decl.h histo.def.h
	$(CHARMC) $(CHARMCFLAGS) -c histo.C

test: $(BINARY)
	$(call run, +p4 ./histo 14 8 )
smp-run:
	./histo -n 1000000 -T 10000 +setcpuaffinity ++ppn 32  +pemap 0-31 +commap 34
non-smp-run:
	./charmrun +p32 ./histo -n 1000000 -T 10000 +setcpuaffinity ++local


clean:
	rm -f *.o *.decl.h *.def.h $(BINARY) charmrun* *.stamp
